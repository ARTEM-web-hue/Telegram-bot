import telegram
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
import re
import math

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
user_scores = {}  # Ð¡Ð»Ð¾Ð²Ð°Ñ€ÑŒ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÑÑ‡ÐµÑ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (id: score)
bot_score = 50  # ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÑ‡ÐµÑ‚ Ð±Ð¾Ñ‚Ð°

# Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ Ñ‡Ð°Ñ‚Ñ‹
ALLOWED_CHAT_IDS = [-1002426240807, -1002300529651]  # Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ID Ñ‡Ð°Ñ‚Ð¾Ð²

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°
def is_allowed_chat(chat_id):
    return chat_id in ALLOWED_CHAT_IDS

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
def start(update, context):
    if not is_allowed_chat(update.effective_chat.id):
        update.message.reply_text("Ð­Ñ‚Ð¾Ñ‚ Ð±Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°Ñ….")
        return
    update.message.reply_text("ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð­Ñ‚Ð¾ Ð±Ð¾Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‡ÐµÑ‚Ð° Ð¾Ñ‡ÐºÐ¾Ð². Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸.")

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
def help_command(update, context):
    if not is_allowed_chat(update.effective_chat.id):
        update.message.reply_text("Ð­Ñ‚Ð¾Ñ‚ Ð±Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°Ñ….")
        return
    update.message.reply_text("Ð¥Ð¾Ñ‡ÐµÑˆÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ð³Ð¾ Ð±Ð¾Ñ‚Ð° Ð² ÑÐ²Ð¾Ð¹ Ñ‡Ð°Ñ‚ Ð¸Ð»Ð¸ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐ²Ð¾ÐµÐ³Ð¾ Ð½Ð° Ð·Ð°ÐºÐ°Ð·? ÐŸÐ¸ÑˆÐ¸ @artemax102")

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /chatchet
def chatchet(update, context):
    if not is_allowed_chat(update.effective_chat.id):
        update.message.reply_text("Ð­Ñ‚Ð¾Ñ‚ Ð±Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°Ñ….")
        return
    total_score = sum(score for user_id, score in user_scores.items() if score >= 51)
    update.message.reply_text(f"ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð±Ð°Ð»Ð»Ð¾Ð² Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² (Ñƒ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… 51 Ð¸ Ð±Ð¾Ð»ÑŒÑˆÐµ): {total_score}")

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /chatone
def chatone(update, context):
    if not is_allowed_chat(update.effective_chat.id):
        update.message.reply_text("Ð­Ñ‚Ð¾Ñ‚ Ð±Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°Ñ….")
        return
    sorted_users = sorted(user_scores.items(), key=lambda x: x[1], reverse=True)
    message = ""
    rank_emotes = ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"]
    place = 1
    for user_id, score in sorted_users:
        if score > 51:
            user = context.bot.get_chat_member(chat_id=update.effective_chat.id, user_id=user_id).user
            username = user.username if user.username else "NoUsername"
            rank = rank_emotes[place - 1] if place <= 3 else ""
            message += f"({place})ðŸ† Ð”Ð¾Ð±Ð°Ð²ÐºÐ¸:{math.floor((score - 50) * 6)}ðŸŽ¯ Ð¡Ñ‡Ñ‘Ñ‚:{score}ðŸ’¥ Ð˜Ð³Ñ€Ð¾Ðº (@{username}) Ð Ð°Ð½Ð³: {rank}\n"
            place += 1
    if not message:
        message = "ÐÐµÑ‚ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ñ Ð±Ð¾Ð»ÐµÐµ Ñ‡ÐµÐ¼ 51 Ð¾Ñ‡ÐºÐ¾Ð¼."
    update.message.reply_text(message)

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /spsbot
def spsbot(update, context):
    if not is_allowed_chat(update.effective_chat.id):
        update.message.reply_text("Ð­Ñ‚Ð¾Ñ‚ Ð±Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°Ñ….")
        return
    global bot_score
    bot_score += 5
    update.message.reply_text("Ðš ÑÑ‡ÐµÑ‚Ñƒ Ð±Ð¾Ñ‚Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ 5 Ð¾Ñ‡ÐºÐ¾Ð²!")

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /spshki
def spshki(update, context):
    if not is_allowed_chat(update.effective_chat.id):
        update.message.reply_text("Ð­Ñ‚Ð¾Ñ‚ Ð±Ð¾Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð°Ñ….")
        return
    update.message.reply_text(f"Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‡ÐµÑ‚ Ð±Ð¾Ñ‚Ð°: {bot_score}")

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ñ€ÐµÐ°ÐºÑ†Ð¸Ð¹
def handle_message(update, context):
    if not is_allowed_chat(update.effective_chat.id):
        return
    global user_scores
    message = update.message.text.lower()
    reply_to_message = update.message.reply_to_message

    if reply_to_message and reply_to_message.from_user.id != context.bot.id:
        target_user_id = reply_to_message.from_user.id
        if target_user_id not in user_scores:
            user_scores[target_user_id] = 50

        if any(word in message for word in ["+", "ÑÐ¿Ñ", "Ð¿Ð¶", "ÑÐ¿Ð°ÑÐ¸Ð±Ð¾", "Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°", "Ð¼Ð¾Ð»Ð¾Ð´ÐµÑ†", "Ð¿Ñ€Ð¸Ð²ÐµÑ‚", "Ð¿Ð¾ÐºÐ°"]):
            sender_score = user_scores.get(update.message.from_user.id, 50)
            points_to_add = math.ceil(sender_score / 6)
            user_scores[target_user_id] += points_to_add
            update.message.reply_text(f"Ð˜Ð³Ñ€Ð¾ÐºÑƒ @{reply_to_message.from_user.username} Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ {points_to_add} Ð¾Ñ‡ÐºÐ¾Ð²!")

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
def main():
    TOKEN = "7272942350:AAFMIlSmk1578vwHwocD0Ny-pNOyM3g8o6c"  # Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ð²Ð°Ñˆ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("help", help_command))
    dp.add_handler(CommandHandler("chatchet", chatchet))
    dp.add_handler(CommandHandler("chatone", chatone))
    dp.add_handler(CommandHandler("spsbot", spsbot))
    dp.add_handler(CommandHandler("spshki", spshki))

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))

    # Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
